<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ECON7110Live</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background-color: #51247A;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .auth-container h2 {
            color: #51247A;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .auth-container input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .auth-container button {
            width: 100%;
            padding: 12px;
            background-color: #51247A;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .auth-container button:hover {
            background-color: #3d1b5c;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #51247A;
            margin-bottom: 20px;
        }
        
        .question-item {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
        }
        
        .question-item.active {
            background-color: #f3f0f7;
            border-color: #51247A;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-text {
            font-weight: 600;
            color: #333;
        }
        
        .question-answers {
            margin-left: 20px;
            color: #666;
        }
        
        .correct-answer {
            color: #2e7d32;
            font-weight: 600;
        }
        
        .question-meta {
            margin-top: 8px;
            font-size: 14px;
            color: #51247A;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #51247A;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .answer-inputs {
            margin-top: 10px;
        }
        
        .answer-input {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .answer-input label {
            width: 30px;
            font-weight: 600;
            color: #51247A;
        }
        
        .answer-input input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #51247A;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3d1b5c;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d0d0d0;
        }
        
        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .qr-section {
            text-align: center;
            padding: 20px;
        }
        
        #qrcode {
            margin: 20px auto;
        }
        
        .url-display {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-top: 10px;
            word-break: break-all;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="header">
            <div class="header-content">
                <h1>Admin Panel - ECON7110 Live</h1>
            </div>
        </div>
        <div class="auth-container">
            <h2>Admin Login</h2>
            <input type="password" id="passwordInput" placeholder="Enter admin password">
            <button onclick="login()">Login</button>
            <div id="loginError" style="color: red; margin-top: 10px; text-align: center;"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="header">
            <div class="header-content">
                <h1>Admin Panel</h1>
                <div class="nav-links">
                    <a href="results.html" target="_blank">View Results</a>
                    <a href="#" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
        
        <div class="container">
            <!-- QR Code Section -->
            <div class="section qr-section">
                <h2>Student Access</h2>
                <p>Students can scan this QR code to access the response system:</p>
                <div id="qrcode"></div>
                <div class="url-display" id="urlDisplay"></div>
            </div>
            
            <!-- Add/Edit Questions -->
            <div class="section">
                <h2>Add New Question</h2>
                <div class="form-group">
                    <label>Question Text:</label>
                    <input type="text" id="questionText" placeholder="Enter your question">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Point Value:</label>
                        <select id="pointValue">
                            <option value="1">1 point</option>
                            <option value="2">2 points</option>
                            <option value="3">3 points</option>
                            <option value="4">4 points</option>
                            <option value="5">5 points</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Correct Answer:</label>
                        <select id="correctAnswer">
                            <option value="">Select after adding answers</option>
                        </select>
                    </div>
                </div>
                <div class="answer-inputs">
                    <div class="answer-input">
                        <label>A.</label>
                        <input type="text" id="answer0" placeholder="Answer option A" onkeyup="updateCorrectAnswerOptions()">
                    </div>
                    <div class="answer-input">
                        <label>B.</label>
                        <input type="text" id="answer1" placeholder="Answer option B" onkeyup="updateCorrectAnswerOptions()">
                    </div>
                    <div class="answer-input">
                        <label>C.</label>
                        <input type="text" id="answer2" placeholder="Answer option C (optional)" onkeyup="updateCorrectAnswerOptions()">
                    </div>
                    <div class="answer-input">
                        <label>D.</label>
                        <input type="text" id="answer3" placeholder="Answer option D (optional)" onkeyup="updateCorrectAnswerOptions()">
                    </div>
                    <div class="answer-input">
                        <label>E.</label>
                        <input type="text" id="answer4" placeholder="Answer option E (optional)" onkeyup="updateCorrectAnswerOptions()">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addQuestion()">Add Question</button>
            </div>

            <div class="section">
                <h2>Settings</h2>
                <div style="margin-bottom: 20px;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="resultsVisibleToggle" onchange="toggleResultsVisibility(this.checked)">
                        <span class="slider"></span>
                    </label>
                    <span>Show results to students</span>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="leaderboardVisibleToggle" onchange="toggleLeaderboardVisibility(this.checked)">
                        <span class="slider"></span>
                    </label>
                    <span>Show leaderboard to students</span>
                </div>
                
                <div style="padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <h3 style="color: #d32f2f; margin-bottom: 10px;">Danger Zone</h3>
                    <button class="btn btn-danger" onclick="clearAllResponses()">
                        Clear All Responses
                    </button>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">
                        This will delete all student responses and scores. Questions will remain.
                    </p>
                </div>
            </div>
            
            <!-- Current Questions -->
            <div class="section">
                <h2>Current Questions</h2>
                <div id="questionsList">
                    <p style="color: #666;">No questions added yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, remove } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBZCW5tAWc-I5XAXqFDRazoeWIhQtNxcu4",
            authDomain: "econ7110.firebaseapp.com",
            databaseURL: "https://econ7110-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "econ7110",
            storageBucket: "econ7110.firebasestorage.app",
            messagingSenderId: "667390196212",
            appId: "1:667390196212:web:59b6cc3983be3a1aa1a1a1"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Simple password protection (in production, use proper authentication)
        const ADMIN_PASSWORD = 'uqadmin2024'; // Change this!
        
        // Update correct answer dropdown when answers change
        window.updateCorrectAnswerOptions = function() {
            const correctAnswerSelect = document.getElementById('correctAnswer');
            const currentValue = correctAnswerSelect.value;
            correctAnswerSelect.innerHTML = '<option value="">Select correct answer</option>';
            
            for (let i = 0; i < 5; i++) {
                const answer = document.getElementById(`answer${i}`).value.trim();
                if (answer) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${String.fromCharCode(65 + i)}. ${answer}`;
                    correctAnswerSelect.appendChild(option);
                }
            }
            
            // Restore previous selection if still valid
            if (currentValue && document.getElementById(`answer${currentValue}`).value.trim()) {
                correctAnswerSelect.value = currentValue;
            }
        };
        
        // Login function
        window.login = function() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadQuestions();
                generateQRCode();
                loadSettings();
                
            } else {
                document.getElementById('loginError').textContent = 'Invalid password';
            }
        };
        
        // Logout function
        window.logout = function() {
            localStorage.removeItem('adminLoggedIn');
            window.location.reload();
        };
        
        // Check if already logged in
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        // Toggle results visibility
        window.toggleResultsVisibility = function(visible) {
            const settingsRef = ref(database, 'settings/resultsVisible');
            set(settingsRef, visible).then(() => {
                console.log('Results visibility set to:', visible);
            }).catch(error => {
                console.error('Error setting visibility:', error);
                alert('Error updating settings');
            });
        };

        // Toggle leaderboard visibility
        window.toggleLeaderboardVisibility = function(visible) {
            const settingsRef = ref(database, 'settings/leaderboardVisible');
            set(settingsRef, visible).then(() => {
                console.log('Leaderboard visibility set to:', visible);
            }).catch(error => {
                console.error('Error setting visibility:', error);
                alert('Error updating settings');
            });
        };

        // initialize the toggles when admin loads
        function loadSettings() {
            const resultsRef = ref(database, 'settings/resultsVisible');
            onValue(resultsRef, (snapshot) => {
                const isVisible = snapshot.val();
                document.getElementById('resultsVisibleToggle').checked = isVisible === true;
            });
            
            const leaderboardRef = ref(database, 'settings/leaderboardVisible');
            onValue(leaderboardRef, (snapshot) => {
                const isVisible = snapshot.val();
                document.getElementById('leaderboardVisibleToggle').checked = isVisible === true;
            });
        }

        // Clear all responses
        window.clearAllResponses = function() {
            if (confirm('Clear all student responses and scores? This cannot be undone.')) {
                const responsesRef = ref(database, 'responses');
                const scoresRef = ref(database, 'currentSession/scores');
                
                Promise.all([
                    set(responsesRef, null),
                    set(scoresRef, null)
                ])
                .then(() => {
                    alert('All responses and scores cleared!');
                })
                .catch(error => {
                    console.error('Error clearing data:', error);
                    alert('Error clearing data: ' + error.message);
                });
            }
        };

        
        
        // Generate QR Code
        function generateQRCode() {
            // Get the current URL and replace admin.html with index.html
            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
            const studentUrl = baseUrl + '/index.html';
            
            document.getElementById('urlDisplay').textContent = studentUrl;
            
            // Clear any existing QR code first
            document.getElementById("qrcode").innerHTML = '';
            
            new QRCode(document.getElementById("qrcode"), {
                text: studentUrl,
                width: 200,
                height: 200,
                colorDark: "#51247A",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        // Add question
        window.addQuestion = function() {
            const questionText = document.getElementById('questionText').value.trim();
            const answers = [];
            const pointValue = parseInt(document.getElementById('pointValue').value);
            const correctAnswer = document.getElementById('correctAnswer').value;
            
            for (let i = 0; i < 5; i++) {
                const answer = document.getElementById(`answer${i}`).value.trim();
                if (answer) {
                    answers.push(answer);
                }
            }
            
            if (!questionText) {
                alert('Please enter a question');
                return;
            }
            
            if (answers.length < 2) {
                alert('Please provide at least 2 answer options');
                return;
            }
            
            if (correctAnswer === '') {
                alert('Please select the correct answer');
                return;
            }
            
            // Check if correct answer index is valid
            const correctIndex = parseInt(correctAnswer);
            if (correctIndex >= answers.length) {
                alert('Invalid correct answer selection');
                return;
            }
            
            // Check total questions
            const questionsRef = ref(database, 'questions');
            onValue(questionsRef, (snapshot) => {
                const existingQuestions = snapshot.val() || {};
                if (Object.keys(existingQuestions).length >= 5) {
                    alert('Maximum 5 questions allowed. Please delete a question first.');
                    return;
                }
                
                // Add the question
                const newQuestionRef = push(questionsRef);
                set(newQuestionRef, {
                    text: questionText,
                    answers: answers,
                    points: pointValue,
                    correctAnswer: correctIndex,
                    active: true,
                    createdAt: Date.now()
                }).then(() => {
                    // Clear form
                    document.getElementById('questionText').value = '';
                    document.getElementById('pointValue').value = '1';
                    document.getElementById('correctAnswer').innerHTML = '<option value="">Select after adding answers</option>';
                    for (let i = 0; i < 5; i++) {
                        document.getElementById(`answer${i}`).value = '';
                    }
                    alert('Question added successfully!');
                }).catch(error => {
                    alert('Error adding question: ' + error.message);
                });
            }, { onlyOnce: true });
        };
        
        // Load questions
        function loadQuestions() {
            const questionsRef = ref(database, 'questions');
            onValue(questionsRef, (snapshot) => {
                const questions = snapshot.val() || {};
                displayQuestions(questions);
            });
        }
        
        // Display questions
        function displayQuestions(questions) {
            const listDiv = document.getElementById('questionsList');
            
            if (Object.keys(questions).length === 0) {
                listDiv.innerHTML = '<p style="color: #666;">No questions added yet.</p>';
                return;
            }
            
            let html = '';
            Object.entries(questions).forEach(([id, question]) => {
                const points = question.points || 1;
                const correctAnswer = question.correctAnswer;
                
                html += `
                    <div class="question-item ${question.active ? 'active' : ''}">
                        <div class="question-header">
                            <div style="flex: 1;">
                                <div class="question-text">${question.text}</div>
                                <div class="question-answers">
                                    ${question.answers.map((ans, idx) => {
                                        const isCorrect = idx === correctAnswer;
                                        return `<span class="${isCorrect ? 'correct-answer' : ''}">${String.fromCharCode(65 + idx)}. ${ans}${isCorrect ? ' ✓' : ''}</span>`;
                                    }).join(' | ')}
                                </div>
                                <div class="question-meta">
                                    Points: ${points} | Correct: ${String.fromCharCode(65 + correctAnswer)}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" ${question.active ? 'checked' : ''} 
                                           onchange="toggleQuestion('${id}', this.checked)">
                                    <span class="slider"></span>
                                </label>
                                <button class="btn btn-danger" onclick="deleteQuestion('${id}')">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        // Toggle question active status
        window.toggleQuestion = function(questionId, active) {
            const questionRef = ref(database, `questions/${questionId}/active`);
            set(questionRef, active);
        };
        
        // Delete question
        window.deleteQuestion = function(questionId) {
            if (confirm('Are you sure you want to delete this question? This will also delete all responses.')) {
                // Delete question
                const questionRef = ref(database, `questions/${questionId}`);
                remove(questionRef);
                
                // Delete responses
                const responsesRef = ref(database, `responses/${questionId}`);
                remove(responsesRef);
            }
        };
        
        // Initialize
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            loadQuestions();
            generateQRCode();
            loadSettings();
        }
        
        // Enter key submits login
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>


</body>
</html>